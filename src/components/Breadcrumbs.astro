---
// src/components/Breadcrumbs.astro
import { SITE, PAGES, UPDATES, absoluteUrl } from '../config';

const { url } = Astro;
// Clean the pathname to handle trailing slashes and index.html
const cleanPathname = url.pathname.replace(/\/index\.html$/, '').replace(/\/$/, '');
const pathSegments = cleanPathname.split('/').filter(p => p);

// Remove the base path segment if it exists (for GitHub Pages)
const basePath = import.meta.env.BASE_URL.replace(/\/$/, '').replace(/^\//, '');
const relevantSegments = basePath ? pathSegments.slice(1) : pathSegments;

const crumbs: { name: string; href?: string }[] = [{ name: 'Home', href: SITE.homeUrl }];

if (relevantSegments.length > 0) {
  switch (relevantSegments[0]) {
    case 'features':
      crumbs.push({ name: PAGES.features.name, href: PAGES.features.href });
      break;
    case 'manifesto':
      crumbs.push({ name: PAGES.manifesto.name, href: PAGES.manifesto.href });
      break;
    case 'updates':
      crumbs.push({ name: PAGES.updates.name, href: PAGES.updates.href });
      if (relevantSegments.length > 1) {
        const update = UPDATES.find(u => u.slug === relevantSegments[1]);
        if (update) {
          crumbs.push({ name: update.title }); // Last crumb is not a link
        }
      }
      break;
  }
}

// Logic for the JSON-LD schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": crumbs.map((crumb, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "name": crumb.name,
    "item": crumb.href ? absoluteUrl(crumb.href) : undefined
  }))
};
---

<nav aria-label="Breadcrumb" class="container mx-auto px-4 mt-8">
  <ol class="flex flex-wrap items-center gap-x-2 gap-y-1 text-xs md:text-sm text-text/60">
    {crumbs.map((crumb, index) => (
      <li class="flex items-center gap-x-2">
        {index > 0 && <span class="opacity-50">/</span>}
        {crumb.href ? (
          <a href={crumb.href} class="hover:text-primary hover:underline">{crumb.name}</a>
        ) : (
          <span class="font-semibold text-text/80">{crumb.name}</span>
        )}
      </li>
    ))}
  </ol>
</nav>

<script type="application/ld+json" is:inline set:html={JSON.stringify(breadcrumbSchema)} />